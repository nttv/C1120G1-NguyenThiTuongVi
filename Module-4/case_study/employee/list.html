<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="/layout/header :: head">
</head>
<body class="custom-background d-flex flex-column">

<header th:replace="/layout/header :: header"></header>
<nav th:replace="/layout/header :: nav-bar"></nav>

<div id="pageContent" class="container mb-4">
    <div class="row d-flex">
        <h2 class="col py-3">Employee List</h2>
        <div class="col text-right my-auto mr-3">
            <button class="btn btn-success p-1" id="createBtn">
                <i class="fas fa-plus"></i> <span>Add New Employee</span>
            </button>
        </div>
    </div>
    <div th:if="${message}">
        <div class="alert alert-success alert-dismissible fade show font-weight-bold">
            <button type="button" class="close btn shadow-none float-right" data-dismiss="alert">&times;</button>
            <span th:text="${message}"></span>
        </div>
    </div>
    <table class="table table-hover text-center" id="employeeTable">
        <thead>
        <tr>
            <th class="px-0">#</th>
            <th class="px-0">ID</th>
            <th class="px-0">Name</th>
            <th class="px-0">Education</th>
            <th class="px-0">Position</th>
            <th class="px-0">Division</th>
            <th class="px-0">Salary</th>
            <th class="px-0">User</th>
            <th class="px-0">Actions</th>
        </tr>
        </thead>
        <tbody id="employeeTableBody">

        </tbody>
    </table>
    <div class="clearfix" id="pagination">

    </div>
</div>

<footer th:replace="/layout/footer :: footer"></footer>
<div th:replace="/modal/delete-confirm :: modal"></div>

<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title mx-auto" id="employeeModalLabel"></h5>
                <button type="button" class="close btn shadow-none ml-0" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button class="btn btn-success" id="employeeBtn"></button>
            </div>
        </div>
    </div>
</div>

<script>

    $.ajax({
        type: "GET",
        url: "/employee/list",
        dataType: "json",
        success: function (data) {
            let employees = data.content;
            let list = showEmployees(employees, data.number * data.size);
            let pages = showPagination(data);
            $("#employeeTableBody").html(list);
            $("#pagination").html(pages);
        }
    });

    $(document).ready(function () {
        $("#searchForm").attr("action", "/employee");

        $(".alert").delay(2000).slideUp(800, function () {
            $(this).alert('close');
        });

        $(".delete").click(function () {
            $("#deleteForm").attr("action", "/employee/" + $(this).val() + "/delete");
            $("#deleteModalBody").html("<p>Do you really want to delete this employee?<br>This process cannot be undone.</p>");
        });

        $("#createBtn").click(function () {
            $.ajax({
                type: "GET",
                url: "/employee/create",
                dataType: "html",
                success: function (data) {
                    $("#employeeModal .modal-body").html(data);
                    $("#employeeModalLabel").text("Add New Employee");
                    $("#employeeForm").attr("action", "/employee/save");
                    $("#employeeBtn").text("Save");
                    $("#employeeModal").modal('show');
                }
            });
        });

        $(".view").click(function () {
            $.ajax({
                type: "GET",
                url: "/employee/" + $(this).val(),
                dataType: "html",
                success: function (data) {
                    $("#employeeModalLabel").text("Employee Detail");
                    $("#employeeModal .modal-body").html(data);
                    $("#employeeForm input").attr("readonly", "true");
                    $("#employeeForm select").attr("disabled", "true");
                    $("#employeeBtn").hide();
                    $("#employeeModal").modal('show');
                }
            });
        });

        $(".edit").click(function () {
            $.ajax({
                type: "GET",
                url: "/employee/" + $(this).val() + "/edit",
                dataType: "html",
                success: function (data) {
                    $("#employeeModalLabel").text("Edit Employee");
                    $("#employeeModal .modal-body").html(data);
                    $("#employeeForm").attr("action", "/employee/update");
                    $("#employeeForm #id").attr("readonly", "true");
                    $("#employeeBtn").text("Update");
                    $("#employeeModal").modal('show');
                }
            });
        });

        $("#employeeBtn").click(function () {
            $("#employeeForm").submit();
        });
    });

    function showEmployees(employees, startIndex) {
        let result = "";
        for (let employee of employees) {
            result += "<tr>"
                + "<td class='px-3 align-middle'>" + ++startIndex + "</td>"
                + "<td class='px-3 align-middle'>" + employee.employeeId + "</td>"
                + "<td class='px-3 align-middle'>" + employee.employeeName + "</td>"
                + "<td class='px-3 align-middle'>" + employee.educationDegree.degreeName + "</td>"
                + "<td class='px-3 align-middle'>" + employee.position.positionName + "</td>"
                + "<td class='px-3 align-middle'>" + employee.division.divisionName + "</td>"
                + "<td class='px-3 align-middle'>" + employee.employeeSalary + "</td>"
                + "<td class='px-3 align-middle'>" + employee.appUser.username + "</td>"
                + "<td class='px-3'>"
                + "<button class='view btn bg-transparent shadow-none text-info' value='" + employee.employeeId + "'>"
                + "<i class='far fa-eye' data-toggle='tooltip' title='View'></i>"
                + "</button>"
                + "<button class='edit btn bg-transparent shadow-none text-warning' value='" + employee.employeeId + "'>"
                + "<i class='fas fa-edit' data-toggle='tooltip' title='Edit'></i>"
                + "</button>"
                + "<button class='delete btn bg-transparent shadow-none text-danger' data-toggle='modal' "
                + "data-target='#deleteModal' value='" + employee.employeeId + "'>"
                + "<i class='fas fa-ban' data-toggle='tooltip' title='Delete'></i>"
                + "</button>"
                + "</td>"
                + "</tr>";
        }
        return result;
    }

    function showPagination(data) {
        let result = "<div class='hint-text'>"
            + "Showing <b>" + data.numberOfElements + "</b> out of <b>" + data.totalElements + "</b> entries"
            + "</div>"
            + "<ul class='pagination'>"
            + "<li class='page-item'><a class='page-link'><i class='fa fa-angle-double-left'></i></a></li>";

        for (let i = 0; i < data.totalPages - 1; i++) {
            result += "<li class='page-item' id='currentPage'>"
                + "<a class='page-link' href='/employee?page=" + i + "'>" + (i + 1) + "</a>"
                + "</li>";
        }
        result += "<li class='page-item'><a class='page-link'><i class='fa fa-angle-double-right'></i></a></li>"
            + "</ul>";

        return result;
    }

</script>

</body>
</html>